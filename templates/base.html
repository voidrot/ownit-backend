{% load static %}
{% load django_htmx %}
{% load tailwind_cli %}
<!DOCTYPE html>
<html lang="en" data-theme="dark">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>
            {% block title %}OwnIt Admin{% endblock title %}
        </title>
        <!-- Tailwind CSS -->
        {% tailwind_css %}
        <!-- HTMX -->
        {% django_htmx_script %}
        {% block extra_head %}{% endblock %}
    </head>
    <body class="min-h-screen flex flex-col bg-base-100 text-base-content" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
        <!-- Global Messages/Toasts -->
        {% if messages %}
            <div class="toast toast-top toast-end z-50">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags|default:'info' }}">
                        <span>{{ message }}</span>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Navbar -->
        <header class="w-full bg-base-100 shadow-md">
            <div class="container max-w-7xl mx-auto px-4">
                <div class="navbar">
                    <div class="navbar-start">
                        <a href="{% url 'pages:landing' %}" class="btn btn-ghost normal-case text-2xl font-semibold">OwnIt Portal</a>
                    </div>

                    <div class="navbar-center md:flex">
                        <ul class="menu menu-horizontal px-1">
                            <li><a href="{% url 'core:chores' %}">Chores</a></li>
                            <li><a href="{% url 'core:behavior' %}">Behavior</a></li>
                            <li><a href="{% url 'core:users' %}">Users</a></li>
                            <li><a href="{% url 'core:settings' %}">Settings</a></li>
                        </ul>
                    </div>

                    <div class="navbar-end gap-2">
                        <!-- Theme selector (always visible) -->
                        <div class="flex items-center">
                            <label for="theme-selector" class="sr-only">Theme</label>
                            <select id="theme-selector" aria-label="Theme selector" class="select select-sm select-ghost">
                                <option value="auto">Auto</option>
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                            </select>
                        </div>

                        <!-- Mobile dropdown for nav -->
                        <div class="lg:hidden">
                            <div class="dropdown dropdown-end">
                                <label tabindex="0" class="btn btn-ghost btn-circle">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                                    </svg>
                                </label>
                                <ul tabindex="0" class="menu menu-compact dropdown-content mt-3 p-2 shadow bg-base-100 rounded-box w-52">
                                    <li><a href="{% url 'core:chores' %}">Chores</a></li>
                                    <li><a href="{% url 'core:behavior' %}">Behavior</a></li>
                                    <li><a href="{% url 'core:users' %}">Users</a></li>
                                    <li><a href="{% url 'core:settings' %}">Settings</a></li>
                                    <li class="md:hidden">
                                        <label for="theme-selector-mobile" class="flex items-center gap-2 px-2">
                                            Theme
                                            <select id="theme-selector-mobile" aria-label="Theme selector mobile" class="select select-sm select-ghost">
                                                <option value="auto">Auto</option>
                                                <option value="light">Light</option>
                                                <option value="dark">Dark</option>
                                            </select>
                                        </label>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Auth links / avatar -->
                        {% if user.is_authenticated %}
                        <div class="dropdown dropdown-end">
                            <label tabindex="0" class="btn btn-ghost btn-circle avatar">
                                <div class="w-8 rounded-full bg-base-200 flex items-center justify-center">
                                    <span class="text-sm">{{ user.first_name|default:user.username|slice:":1"|upper }}</span>
                                </div>
                            </label>
                            <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                                <li><a href="{% url 'account_change_password' %}">Change Password</a></li>
                                <li><a href="{% url 'account_logout' %}">Logout</a></li>
                            </ul>
                        </div>
                        {% else %}
                            <a class="btn btn-ghost" href="{% url 'account_login' %}">Login</a>
                            <a class="btn btn-primary" href="{% url 'account_signup' %}">Sign Up</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 py-8">
            {% block content %}{% endblock %}
        </main>

        <!-- Footer -->
        <footer class="footer footer-center p-6 bg-base-300 text-base-content">
            <aside>
                <p>Copyright Â© {% now "Y" %} - OwnIt</p>
            </aside>
        </footer>

        {% block extra_script %}{% endblock %}

        <script>
            (function() {
                // Shared theme logic for desktop and mobile selectors
                const desktop = document.getElementById('theme-selector');
                const mobile = document.getElementById('theme-selector-mobile');
                const storageKey = 'theme'; // values: 'auto'|'light'|'dark'

                function prefersDark() {
                    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                }

                function applyTheme(value) {
                    if (value === 'auto') {
                        document.documentElement.setAttribute('data-theme', prefersDark() ? 'dark' : 'light');
                    } else {
                        document.documentElement.setAttribute('data-theme', value);
                    }
                    // keep both selectors in sync
                    try {
                        if (desktop) desktop.value = value;
                        if (mobile) mobile.value = value;
                    } catch (e) {}
                }

                // Initialize selector and theme
                const saved = localStorage.getItem(storageKey) || 'auto';
                applyTheme(saved);

                // set selector values
                if (desktop) desktop.value = saved;
                if (mobile) mobile.value = saved;

                // Listen for system theme changes when in 'auto' mode
                if (window.matchMedia) {
                    const mql = window.matchMedia('(prefers-color-scheme: dark)');
                    mql.addEventListener('change', () => {
                        const current = localStorage.getItem(storageKey) || 'auto';
                        if (current === 'auto') applyTheme('auto');
                    });
                }

                function onChange(v) {
                    try { localStorage.setItem(storageKey, v); } catch (e) {}
                    applyTheme(v);
                }

                if (desktop) desktop.addEventListener('change', function() { onChange(this.value); });
                if (mobile) mobile.addEventListener('change', function() { onChange(this.value); });
            })();
        </script>
    </body>
</html>

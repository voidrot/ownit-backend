{% extends 'base.html' %}
{% block title %}Users ‚Äî Portal{% endblock %}
{% block content %}
<div class="container mx-auto px-4">
	<div class="flex flex-col md:flex-row md:items-start gap-6 md:gap-8 py-6">
		<!-- Left: Create form (collapsible card, constrained width) -->
		<section class="w-full md:w-1/3">
			<div class="max-w-md mx-auto">
				<div class="collapse">
					<input type="checkbox" aria-hidden="true" />
					<div class="collapse-title text-lg font-medium btn btn-success">Create New User</div>
					<div class="collapse-content">
						<div class="card bg-base-200 shadow-lg">
							<div class="card-body">
								<p class="text-sm text-muted">Create a parent or child account. Emails are recorded and marked verified for portal access.</p>

								<form method="post" id="create-user-form" class="mt-4 space-y-4">
									{% csrf_token %}
									<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" />

									<div class="form-control">
										<label class="label">
											<span class="label-text">Username <span class="text-red-500">*</span></span>
										</label>
										{{ form.username }}
										<span class="text-sm text-muted mt-1">Choose a unique username.</span>
										{{ form.username.errors }}
									</div>

									<div class="flex gap-2">
										<div class="form-control flex-1">
											<label class="label">
												<span class="label-text">First name</span>
											</label>
											{{ form.first_name }}
											{{ form.first_name.errors }}
										</div>

										<div class="form-control flex-1">
											<label class="label">
												<span class="label-text">Last name</span>
											</label>
											{{ form.last_name }}
											{{ form.last_name.errors }}
										</div>
									</div>

									<div class="form-control">
										<label class="label">
											<span class="label-text">Email <span class="text-red-500">*</span></span>
										</label>
										{{ form.email }}
										<span class="text-sm text-muted mt-1">We will mark this email as verified for portal access.</span>
										{{ form.email.errors }}
									</div>

									<div class="form-control relative">
										<label class="label">
											<span class="label-text">Password <span class="text-red-500">*</span></span>
										</label>
										{{ form.password1 }}
										<button type="button" id="toggle-password1" class="btn btn-ghost btn-sm absolute right-3 top-12" aria-label="Toggle password visibility">üëÅÔ∏è</button>
										<span class="text-sm text-muted">Minimum 8 characters recommended.</span>
										<p class="text-sm text-error mt-1" id="password1-error" aria-live="polite"></p>
										{{ form.password1.errors }}
									</div>

									<div class="form-control relative">
										<label class="label">
											<span class="label-text">Confirm Password <span class="text-red-500">*</span></span>
										</label>
										{{ form.password2 }}
										<button type="button" id="toggle-password2" class="btn btn-ghost btn-sm absolute right-3 top-12" aria-label="Toggle confirm password visibility">üëÅÔ∏è</button>
										<p class="text-sm text-error mt-1" id="password2-error" aria-live="polite"></p>
										{{ form.password2.errors }}
									</div>

									<div class="form-control">
										<label class="label">
											<span class="label-text">Role <span class="text-red-500">*</span></span>
										</label>
										{{ form.group }}
										{{ form.group.errors }}
									</div>

									<div class="form-control mt-2">
										<button id="create-user-btn" type="submit" class="btn btn-primary w-full" disabled>
											<span id="create-btn-text">Create user</span>
											<span id="create-btn-spinner" class="ml-2 hidden">‚è≥</span>
										</button>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

		<!-- Right: Users list -->
		<section class="w-full md:w-2/3">
			<div class="card bg-base-200 shadow-sm  mt-6">
				<div class="card-body">
					<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
						<h2 class="text-lg font-medium">Existing Users</h2>
						<span class="text-sm text-muted mt-1 sm:mt-0 sm:ml-3">{{ users|length }} users</span>
					</div>

					<div class="overflow-x-auto mt-4">
						<table class="table table-zebra w-full">
							<thead>
								<tr>
									<th>Username</th>
									<th>First name</th>
									<th>Last name</th>
									<th>Email</th>
									<th>Groups</th>
									<th class="text-right">Actions</th>
								</tr>
							</thead>
							<tbody>
								{% for user in users %}
								<tr>
									<td class="align-middle">{{ user.username }}</td>
									<td class="align-middle">{{ user.first_name }}</td>
									<td class="align-middle">{{ user.last_name }}</td>
									<td class="align-middle">{{ user.email }}</td>
									<td class="align-middle">{% for group in user.groups.all %}<span class="badge badge-outline mr-1">{{ group.name }}</span>{% endfor %}</td>
									<td class="text-right align-middle">
										<label for="modal-change-pw-{{ user.id }}" class="btn btn-sm btn-outline mr-2">Change Password</label>

										<form method="post" action="{% url 'core:delete_user' user.id %}" class="inline">
											{% csrf_token %}
											<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" />
											<button type="submit" class="btn btn-sm btn-error" onclick="return confirm('Are you sure you want to delete this user?')">Delete</button>
										</form>

										<!-- Change Password Modal (daisyUI checkbox-toggle) -->
										<input type="checkbox" id="modal-change-pw-{{ user.id }}" class="modal-toggle" />
										<div class="modal">
											<div class="modal-box text-left">
												<h3 class="font-bold text-lg">Change password for {{ user.username }}</h3>
												<form class="change-pw-form mt-4" method="post" action="{% url 'core:change_password' user.id %}">
													{% csrf_token %}
													<input type="hidden" name="modal_id" value="modal-change-pw-{{ user.id }}" />
													<div class="form-control">
														<label class="label"><span class="label-text">New password</span></label>
														<input type="password" name="password1" class="input input-bordered w-full" required minlength="8" />
													</div>
													<div class="form-control mt-2">
														<label class="label"><span class="label-text">Confirm password</span></label>
														<input type="password" name="password2" class="input input-bordered w-full" required minlength="8" />
													</div>
													<div class="modal-action">
														<label for="modal-change-pw-{{ user.id }}" class="btn">Cancel</label>
														<button type="submit" class="btn btn-primary">Change</button>
													</div>
												</form>
											</div>
										</div>
									</td>
								</tr>
								{% empty %}
								<tr>
									<td colspan="6" class="text-center py-8 text-muted">No users found</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</section>
	</div>
</div>

<!-- Consolidated JS (validation, toggles, AJAX submit) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
		// Element references (prefer name selectors as Django forms may wrap inputs)
		const groupSelect = document.querySelector('select[name="group"]') || document.getElementById('{{ form.group.id_for_label }}');
		const submitBtn = document.getElementById('create-user-btn');
		const username = document.querySelector('input[name="username"]');
		const email = document.querySelector('input[name="email"]');
		const password1 = document.querySelector('input[name="password1"]');
		const password2 = document.querySelector('input[name="password2"]');
		const pwd1Error = document.getElementById('password1-error');
		const pwd2Error = document.getElementById('password2-error');
		const createBtnText = document.getElementById('create-btn-text');
		const createBtnSpinner = document.getElementById('create-btn-spinner');
		const togglePwd1 = document.getElementById('toggle-password1');
		const togglePwd2 = document.getElementById('toggle-password2');

		function validatePasswordStrength() {
				if (!password1) return true;
				const val = password1.value || '';
				if (val.length < 8) {
						if (pwd1Error) pwd1Error.textContent = 'Password must be at least 8 characters.';
						return false;
				}
				if (pwd1Error) pwd1Error.textContent = '';
				return true;
		}

		function validatePasswordsMatch() {
				if (!password1 || !password2) return true;
				if (password1.value !== password2.value) {
						if (pwd2Error) pwd2Error.textContent = 'Passwords do not match.';
						return false;
				}
				if (pwd2Error) pwd2Error.textContent = '';
				return true;
		}

		function validateEmail() {
				if (!email) return true;
				const v = (email.value || '').trim();
				if (!v) return false;
				const re = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
				return re.test(v);
		}

		function validateUsername() {
				if (!username) return true;
				return (username.value || '').trim().length > 0;
		}

		function checkForm() {
				if (!submitBtn) return;
				const roleSelected = !!(groupSelect && groupSelect.value);
				const ok = roleSelected && validateUsername() && validateEmail() && validatePasswordStrength() && validatePasswordsMatch();
				submitBtn.disabled = !ok;
		}

		// Attach listeners
		if (groupSelect) groupSelect.addEventListener('change', checkForm);
		if (username) username.addEventListener('input', checkForm);
		if (email) email.addEventListener('input', checkForm);
		if (password1) password1.addEventListener('input', function() { validatePasswordStrength(); validatePasswordsMatch(); checkForm(); });
		if (password2) password2.addEventListener('input', function() { validatePasswordsMatch(); checkForm(); });

		if (togglePwd1) togglePwd1.addEventListener('click', function() {
				if (!password1) return;
				password1.type = password1.type === 'password' ? 'text' : 'password';
		});
		if (togglePwd2) togglePwd2.addEventListener('click', function() {
				if (!password2) return;
				password2.type = password2.type === 'password' ? 'text' : 'password';
		});

		// AJAX submit to allow animation on success
		const form = document.getElementById('create-user-form');
		if (form) {
				form.addEventListener('submit', function(e) {
						e.preventDefault();
						if (!submitBtn || submitBtn.disabled) return;
						if (createBtnSpinner) createBtnSpinner.classList.remove('hidden');
						if (createBtnText) createBtnText.textContent = 'Creating...';

						const data = new FormData(form);
						fetch(form.action || window.location.href, {
								method: 'POST',
								body: data,
								credentials: 'same-origin'
						}).then(function(resp) {
								if (resp.ok) {
										if (createBtnSpinner) createBtnSpinner.classList.add('hidden');
										if (createBtnText) createBtnText.textContent = 'Created ‚úì';
										if (submitBtn) submitBtn.classList.add('scale-105');
										setTimeout(function() { window.location.reload(); }, 800);
								} else {
										// server returned an error page (validation). Reload to show server errors
										resp.text().then(function() { window.location.reload(); });
								}
						}).catch(function() {
								// network error: re-enable button
								if (createBtnSpinner) createBtnSpinner.classList.add('hidden');
								if (createBtnText) createBtnText.textContent = 'Create User';
								if (submitBtn) submitBtn.disabled = false;
						});
				});
		}

		// initial validation check
		checkForm();

		// Handle change-password forms via AJAX so modals can close on success
		document.querySelectorAll('.change-pw-form').forEach(function(cpForm) {
			cpForm.addEventListener('submit', function(e) {
				e.preventDefault();
				const submitBtn = cpForm.querySelector('button[type="submit"]');
				if (submitBtn) submitBtn.disabled = true;
				const data = new FormData(cpForm);
				fetch(cpForm.action, {
					method: 'POST',
					body: data,
					credentials: 'same-origin'
				}).then(function(resp) {
					if (resp.ok) {
						// close modal
						const modalId = cpForm.querySelector('input[name="modal_id"]').value;
						const toggle = document.getElementById(modalId);
						if (toggle) toggle.checked = false;
						setTimeout(function() { window.location.reload(); }, 600);
					} else {
						resp.json().then(function(json) {
							alert((json.messages && json.messages.join('\n')) || json.error || 'Failed to change password');
							if (submitBtn) submitBtn.disabled = false;
						}).catch(function() {
							alert('Failed to change password');
							if (submitBtn) submitBtn.disabled = false;
						});
					}
				}).catch(function() {
					alert('Network error');
					if (submitBtn) submitBtn.disabled = false;
				});
			});
		});
});
</script>
{% endblock %}
*** End Patch
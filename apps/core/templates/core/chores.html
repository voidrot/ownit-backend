{% extends 'base.html' %}
{% load static %}
{% block title %}Chores — Portal{% endblock %}
{% block content %}
    <div class="container mx-auto px-4 py-6">
        <div class="flex flex-col gap-6 md:flex-row">
            <section class="w-full md:w-1/3">
                <div class="mt-4">
                    <h4 class="font-medium">Create / Update</h4>
                    <div class="mt-2">
                        <div role="tablist" aria-label="Create / Update tabs" class="tabs">
                            <button type="button"
                                    role="tab"
                                    class="tab tab-lifted tab-active"
                                    data-tab="chore"
                                    aria-selected="true">Create Chore</button>
                            <button type="button"
                                    role="tab"
                                    class="tab tab-lifted"
                                    data-tab="location"
                                    aria-selected="false">Location</button>
                            <button type="button"
                                    role="tab"
                                    class="tab tab-lifted"
                                    data-tab="equipment"
                                    aria-selected="false">Equipment</button>
                            <button type="button"
                                    role="tab"
                                    class="tab tab-lifted"
                                    data-tab="task"
                                    aria-selected="false">Task</button>
                        </div>
                        <div class="mt-3">
                            <div class="quick-add-panel" data-panel="chore">
                                <form method="post"
                                      action="{% url 'core:save_chore' %}"
                                      class="mt-0 space-y-3"
                                      enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div>
                                        {{ chore_form.name.label_tag }}
                                        {{ chore_form.name }}
                                        {% if chore_form.name.errors %}<p class="text-error text-sm mt-1">{{ chore_form.name.errors|join:' ' }}</p>{% endif %}
                                    </div>
                                    <div>
                                        {{ chore_form.description.label_tag }}
                                        {{ chore_form.description }}
                                        {% if chore_form.description.errors %}
                                            <p class="text-error text-sm mt-1">{{ chore_form.description.errors|join:' ' }}</p>
                                        {% endif %}
                                    </div>
                                    <div class="flex gap-2 items-end">
                                        <div class="flex-1">
                                            {{ chore_form.points.label_tag }}
                                            {{ chore_form.points }}
                                            {% if chore_form.points.errors %}
                                                <p class="text-error text-sm mt-1">{{ chore_form.points.errors|join:' ' }}</p>
                                            {% endif %}
                                        </div>
                                        <div>
                                            {{ chore_form.is_recurring }}
                                            {{ chore_form.is_recurring.label_tag }}
                                            {% if chore_form.is_recurring.errors %}
                                                <p class="text-error text-sm mt-1">{{ chore_form.is_recurring.errors|join:' ' }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div id="recurrence-block" class="space-y-2">
                                        <div>
                                            {{ chore_form.recurrence.label_tag }}
                                            {{ chore_form.recurrence }}
                                            {% if chore_form.recurrence.errors %}
                                                <p class="text-error text-sm mt-1">{{ chore_form.recurrence.errors|join:' ' }}</p>
                                            {% endif %}
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                {{ chore_form.recurrence_day_of_week.label_tag }}
                                                {{ chore_form.recurrence_day_of_week }}
                                                {% if chore_form.recurrence_day_of_week.errors %}
                                                    <p class="text-error text-sm mt-1">{{ chore_form.recurrence_day_of_week.errors|join:' ' }}</p>
                                                {% endif %}
                                            </div>
                                            <div>
                                                {{ chore_form.recurrence_day_of_month.label_tag }}
                                                {{ chore_form.recurrence_day_of_month }}
                                                {% if chore_form.recurrence_day_of_month.errors %}
                                                    <p class="text-error text-sm mt-1">{{ chore_form.recurrence_day_of_month.errors|join:' ' }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            {{ chore_form.location.label_tag }}
                                            {{ chore_form.location }}
                                            {% if chore_form.location.errors %}
                                                <p class="text-error text-sm mt-1">{{ chore_form.location.errors|join:' ' }}</p>
                                            {% endif %}
                                        </div>
                                        <div>
                                            {{ chore_form.time_due.label_tag }}
                                            {{ chore_form.time_due }}
                                            {% if chore_form.time_due.errors %}
                                                <p class="text-error text-sm mt-1">{{ chore_form.time_due.errors|join:' ' }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block">Equipment</label>
                                        <div class="relative mb-2">
                                            <input id="chore-equipment-filter"
                                                   type="search"
                                                   placeholder="Filter equipment"
                                                   class="input input-sm input-bordered w-full pr-12"
                                                   aria-label="Filter equipment" />
                                            <button type="button"
                                                    id="chore-equipment-clear"
                                                    class="absolute right-2 top-1/2 -translate-y-1/2 btn btn-ghost btn-xs h-7 w-7 p-0 rounded-full flex items-center justify-center"
                                                    aria-label="Clear equipment filter">✕</button>
                                        </div>
                                        <div id="chore-equipment-options"
                                             class="border rounded p-2 h-32 overflow-y-auto">
                                            {% with selected=chore_form.equipment.value %}
                                                {% for eq in equipment %}
                                                    <label class="flex items-center gap-2 py-1">
                                                        <input type="checkbox"
                                                               name="equipment"
                                                               value="{{ eq.id }}"
                                                               class="chore-equipment-checkbox"
                                                               {% if selected and eq.id|stringformat:"s" in selected %}checked{% else %}{% if chore_form.instance and eq in chore_form.instance.equipment.all %}checked{% endif %}
                                                               {% endif %} />
                                                        <span class="text-sm">{{ eq.name }}</span>
                                                    </label>
                                                {% endfor %}
                                            {% endwith %}
                                        </div>
                                        {% if chore_form.equipment.errors %}
                                            <p class="text-error text-sm mt-1">{{ chore_form.equipment.errors|join:' ' }}</p>
                                        {% endif %}
                                        <p class="text-sm text-muted mt-1">Select one or more equipment items (up to scrollable list shown).</p>
                                    </div>
                                    <div>
                                        <label class="block">Tasks</label>
                                        <div class="relative mb-2">
                                            <input id="chore-tasks-filter"
                                                   type="search"
                                                   placeholder="Filter tasks"
                                                   class="input input-sm input-bordered w-full pr-12"
                                                   aria-label="Filter tasks" />
                                            <button type="button"
                                                    id="chore-tasks-clear"
                                                    class="absolute right-2 top-1/2 -translate-y-1/2 btn btn-ghost btn-xs h-7 w-7 p-0 rounded-full flex items-center justify-center"
                                                    aria-label="Clear tasks filter">✕</button>
                                        </div>
                                        <div id="chore-tasks-options"
                                             class="border rounded p-2 h-32 overflow-y-auto">
                                            {% with selected=chore_form.tasks.value %}
                                                {% for t in tasks %}
                                                    <label class="flex items-center gap-2 py-1">
                                                        <input type="checkbox"
                                                               name="tasks"
                                                               value="{{ t.id }}"
                                                               class="chore-tasks-checkbox"
                                                               {% if selected and t.id|stringformat:"s" in selected %}checked{% else %}{% if chore_form.instance and t in chore_form.instance.tasks.all %}checked{% endif %}
                                                               {% endif %} />
                                                        <span class="text-sm">{{ t.name }}</span>
                                                    </label>
                                                {% endfor %}
                                            {% endwith %}
                                        </div>
                                        {% if chore_form.tasks.errors %}
                                            <p class="text-error text-sm mt-1">{{ chore_form.tasks.errors|join:' ' }}</p>
                                        {% endif %}
                                        <p class="text-sm text-muted mt-1">Select tasks to attach to this chore.</p>
                                    </div>
                                    <div>
                                        <label class="block">Notes</label>
                                        <div id="chore-notes-inputs" class="space-y-2">
                                            <div class="flex gap-2">
                                                <input id="chore-note-text"
                                                       type="text"
                                                       class="input input-bordered w-full"
                                                       placeholder="Add a note" />
                                                <button type="button" id="add-chore-note" class="btn btn-sm">Add</button>
                                            </div>
                                            <ul id="chore-notes-list"
                                                class="list-disc list-inside text-sm text-muted">
                                            </ul>
                                        </div>
                                        {{ chore_form.notes }}
                                        {% if chore_form.notes.errors %}
                                            <p class="text-error text-sm mt-1">{{ chore_form.notes.errors|join:' ' }}</p>
                                        {% endif %}
                                        <p class="text-sm text-muted mt-1">Add optional notes for this chore.</p>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <div>
                                            {{ chore_form.penalize_incomplete }}
                                            {{ chore_form.penalize_incomplete.label_tag }}
                                            {% if chore_form.penalize_incomplete.errors %}
                                                <p class="text-error text-sm mt-1">{{ chore_form.penalize_incomplete.errors|join:' ' }}</p>
                                            {% endif %}
                                        </div>
                                        <div class="w-40">
                                            {{ chore_form.penalty_amount.label_tag }}
                                            {{ chore_form.penalty_amount }}
                                            {% if chore_form.penalty_amount.errors %}
                                                <p class="text-error text-sm mt-1">{{ chore_form.penalty_amount.errors|join:' ' }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <div class="collapse">
                                            <input id="collapse-instructions-video-toggle"
                                                   type="checkbox"
                                                   class="sr-only" />
                                            <label for="collapse-instructions-video-toggle" class="collapse-title p-0">
                                                <div class="flex items-center justify-between">
                                                    <span class="font-semibold">Instructional video (optional)</span>
                                                    <span class="text-sm text-muted">Click to expand</span>
                                                </div>
                                            </label>
                                            <div class="collapse-content p-0 overflow-visible">
                                                <div class="space-y-2 p-3 border rounded overflow-visible">
                                                    <div>
                                                        <label class="block font-semibold">
                                                            Upload video file
                                                            <button type="button"
                                                                    class="btn btn-ghost btn-xs p-0 ml-2"
                                                                    title="Choose a video file to upload. If you prefer to use an external video link, leave this field blank."
                                                                    aria-label="Help: upload video">?</button>
                                                        </label>
                                                        {{ chore_form.instructions_video }}
                                                        {% if chore_form.instructions_video.errors %}
                                                            <p class="text-error text-sm mt-1">{{ chore_form.instructions_video.errors|join:' ' }}</p>
                                                        {% endif %}
                                                    </div>
                                                    <div>
                                                        <label class="block">
                                                            File display name (optional)
                                                            <button type="button"
                                                                    class="btn btn-ghost btn-xs p-0 ml-2"
                                                                    title="A human-friendly name to show in the UI for this uploaded file."
                                                                    aria-label="Help: file display name">?</button>
                                                        </label>
                                                        {{ chore_form.instructions_video_name }}
                                                        {% if chore_form.instructions_video_name.errors %}
                                                            <p class="text-error text-sm mt-1">{{ chore_form.instructions_video_name.errors|join:' ' }}</p>
                                                        {% endif %}
                                                    </div>
                                                    <div>
                                                        <label class="block font-semibold">
                                                            Or: External video URL
                                                            <button type="button"
                                                                    class="btn btn-ghost btn-xs p-0 ml-2"
                                                                    title="Paste a public video URL (YouTube, Vimeo, etc.). If uploading a file above, leave this blank."
                                                                    aria-label="Help: external video URL">?</button>
                                                        </label>
                                                        {{ chore_form.instructions_video_source }}
                                                        {% if chore_form.instructions_video_source.errors %}
                                                            <p class="text-error text-sm mt-1">{{ chore_form.instructions_video_source.errors|join:' ' }}</p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% if chore_form.instance and chore_form.instance.pk %}
                                        <input type="hidden" name="id" value="{{ chore_form.instance.pk }}" />
                                    {% endif %}
                                    <div class="flex items-center gap-2 mt-3">
                                        <button class="btn btn-primary" type="submit">
                                            {% if chore_form.instance and chore_form.instance.pk %}
                                                Update chore
                                            {% else %}
                                                Create chore
                                            {% endif %}
                                        </button>
                                        {% if chore_form.instance and chore_form.instance.pk %}
                                            <a href="{% url 'core:chores' %}" class="btn btn-ghost">Cancel</a>
                                        {% endif %}
                                    </div>
                                </form>
                            </div>
                            <div class="quick-add-panel hidden" data-panel="location">
                                <form id="location-form"
                                      method="post"
                                      action="{% url 'core:save_location' %}"
                                      class="space-y-2">
                                    {% csrf_token %}
                                    <div>
                                        <label class="block">Location name</label>
                                        {{ location_form.name }}
                                        {% if location_form.name.errors %}
                                            <p class="text-error text-sm mt-1">{{ location_form.name.errors|join:' ' }}</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <label class="block">Description</label>
                                        {{ location_form.description }}
                                        {% if location_form.description.errors %}
                                            <p class="text-error text-sm mt-1">{{ location_form.description.errors|join:' ' }}</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <label class="block">Notes</label>
                                        <div id="location-notes-inputs" class="space-y-2">
                                            <div class="flex gap-2">
                                                <input id="location-note-text"
                                                       type="text"
                                                       class="input input-bordered w-full"
                                                       placeholder="Add a note" />
                                                <button type="button" id="add-location-note" class="btn btn-sm">Add</button>
                                            </div>
                                            <ul id="location-notes-list"
                                                class="list-disc list-inside text-sm text-muted">
                                            </ul>
                                        </div>
                                        {{ location_form.notes }}
                                        {% if location_form.notes.errors %}
                                            <p class="text-error text-sm mt-1">{{ location_form.notes.errors|join:' ' }}</p>
                                        {% endif %}
                                    </div>
                                    {% if location_form.instance and location_form.instance.pk %}
                                        <input type="hidden" name="id" value="{{ location_form.instance.pk }}" />
                                    {% endif %}
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-primary" type="submit">Add Location</button>
                                    </div>
                                </form>
                            </div>
                            <div class="quick-add-panel hidden" data-panel="equipment">
                                <form method="post"
                                      action="{% url 'core:create_equipment' %}"
                                      class="space-y-2"
                                      enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div>
                                        {{ equipment_form.name.label_tag }}
                                        {{ equipment_form.name }}
                                        {% if equipment_form.name.errors %}
                                            <p class="text-error text-sm mt-1">{{ equipment_form.name.errors|join:' ' }}</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <label class="block">Description</label>
                                        {{ equipment_form.description }}
                                        {% if equipment_form.description.errors %}
                                            <p class="text-error text-sm mt-1">{{ equipment_form.description.errors|join:' ' }}</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <label class="block">Location</label>
                                        {{ equipment_form.location }}
                                        {% if equipment_form.location.errors %}
                                            <p class="text-error text-sm mt-1">{{ equipment_form.location.errors|join:' ' }}</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <label class="block">Image</label>
                                        <div id="equipment-image-preview" class="mb-2">
                                            {% if equipment_form.instance and equipment_form.instance.pk and equipment_form.instance.image %}
                                                <div class="flex items-center gap-3">
                                                    <img src="{{ equipment_form.instance.image.url }}"
                                                         alt="{{ equipment_form.instance.name }}"
                                                         class="w-16 h-12 object-cover rounded" />
                                                    <label class="inline-flex items-center gap-2">
                                                        <input type="checkbox" name="remove_image" value="1" />
                                                        <span class="text-sm">Remove existing image</span>
                                                    </label>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <input type="file"
                                               name="image"
                                               id="equipment-image"
                                               accept="image/*"
                                               class="file-input file-input-bordered w-full" />
                                        {% if equipment_form.image.errors %}
                                            <p class="text-error text-sm mt-1">{{ equipment_form.image.errors|join:' ' }}</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <label class="block">Notes</label>
                                        <div id="equipment-notes-inputs" class="space-y-2">
                                            <div class="flex gap-2">
                                                <input id="equipment-note-text"
                                                       type="text"
                                                       class="input input-bordered w-full"
                                                       placeholder="Add a note" />
                                                <button type="button" id="add-equipment-note" class="btn btn-sm">Add</button>
                                            </div>
                                            <ul id="equipment-notes-list"
                                                class="list-disc list-inside text-sm text-muted">
                                            </ul>
                                        </div>
                                        {{ equipment_form.notes }}
                                        {% if equipment_form.notes.errors %}
                                            <p class="text-error text-sm mt-1">{{ equipment_form.notes.errors|join:' ' }}</p>
                                        {% endif %}
                                    </div>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-primary" type="submit">
                                            {% if equipment_form.instance and equipment_form.instance.pk %}
                                                Update Equipment
                                            {% else %}
                                                Add Equipment
                                            {% endif %}
                                        </button>
                                    </div>
                                </form>
                            </div>
                            <div class="quick-add-panel hidden" data-panel="task">
                                <form method="post" action="{% url 'core:create_task' %}" class="space-y-2">
                                    {% csrf_token %}
                                    <div>
                                        {{ task_form.name.label_tag }}
                                        {{ task_form.name }}
                                        {% if task_form.name.errors %}<p class="text-error text-sm mt-1">{{ task_form.name.errors|join:' ' }}</p>{% endif %}
                                    </div>
                                    <div>
                                        <label class="block">Description</label>
                                        {{ task_form.description }}
                                        {% if task_form.description.errors %}
                                            <p class="text-error text-sm mt-1">{{ task_form.description.errors|join:' ' }}</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <label class="block">Equipment</label>
                                        <div class="relative mb-2">
                                            <input id="task-equipment-filter"
                                                   type="search"
                                                   placeholder="Filter equipment"
                                                   class="input input-sm input-bordered w-full pr-12"
                                                   aria-label="Filter equipment for task" />
                                            <button type="button"
                                                    id="task-equipment-clear"
                                                    class="absolute right-2 top-1/2 -translate-y-1/2 btn btn-ghost btn-xs h-7 w-7 p-0 rounded-full flex items-center justify-center"
                                                    aria-label="Clear equipment filter for task">✕</button>
                                        </div>
                                        <div id="task-equipment-options"
                                             class="border rounded p-2 h-32 overflow-y-auto">
                                            {% with selected=task_form.equipment.value %}
                                                {% for eq in equipment %}
                                                    <label class="flex items-center gap-2 py-1">
                                                        <input type="checkbox"
                                                               name="equipment"
                                                               value="{{ eq.id }}"
                                                               class="task-equipment-checkbox"
                                                               {% if selected and eq.id|stringformat:"s" in selected %}checked{% else %}{% if task_form.instance and eq in task_form.instance.equipment.all %}checked{% endif %}
                                                               {% endif %} />
                                                        <span class="text-sm">{{ eq.name }}</span>
                                                    </label>
                                                {% endfor %}
                                            {% endwith %}
                                        </div>
                                        {% if task_form.equipment.errors %}
                                            <p class="text-error text-sm mt-1">{{ task_form.equipment.errors|join:' ' }}</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <label class="block">Notes</label>
                                        <div id="task-notes-inputs" class="space-y-2">
                                            <div class="flex gap-2">
                                                <input id="task-note-text"
                                                       type="text"
                                                       class="input input-bordered w-full"
                                                       placeholder="Add a note" />
                                                <button type="button" id="add-task-note" class="btn btn-sm">Add</button>
                                            </div>
                                            <ul id="task-notes-list" class="list-disc list-inside text-sm text-muted">
                                            </ul>
                                        </div>
                                        {{ task_form.notes }}
                                        {% if task_form.notes.errors %}<p class="text-error text-sm mt-1">{{ task_form.notes.errors|join:' ' }}</p>{% endif %}
                                    </div>
                                    <div>
                                        <label class="block">Steps</label>
                                        <div id="task-steps-inputs" class="space-y-2">
                                            <div class="grid grid-cols-2 gap-2">
                                                <input id="task-step-name"
                                                       type="text"
                                                       class="input input-bordered"
                                                       placeholder="Step name" />
                                                <input id="task-step-desc"
                                                       type="text"
                                                       class="input input-bordered"
                                                       placeholder="Step description (optional)" />
                                            </div>
                                            <div class="flex gap-2">
                                                <button type="button" id="add-task-step" class="btn btn-sm">Add Step</button>
                                                <span class="text-sm text-muted mt-2">Add multiple steps; reorder with the arrows.</span>
                                            </div>
                                            <ul id="task-steps-list"
                                                class="list-decimal list-inside text-sm text-muted">
                                            </ul>
                                        </div>
                                        {{ task_form.steps }}
                                        {% if task_form.steps.errors %}<p class="text-error text-sm mt-1">{{ task_form.steps.errors|join:' ' }}</p>{% endif %}
                                    </div>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-primary" type="submit">Add Task</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section class="w-full md:w-2/3">
                <!-- Top related cards: Tasks, Equipment, Locations (placed to right of create tabs) -->
                <div class="grid gap-4 mb-4">
                    <div class="card bg-base-200 shadow-sm">
                        <div class="card-body">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-medium">Chores</h2>
                                <span class="text-sm text-muted">{{ chores|length }} chores</span>
                            </div>
                            <div class="mt-4">
                                {% if chores %}
                                    <div class="space-y-3">
                                        {% for chore in chores %}
                                            <div class="collapse card bg-base-100 shadow-sm rounded-lg mb-3"
                                                 id="chore-card-{{ chore.id }}"
                                                 data-equipment-ids="{% for eq in chore.equipment.all %}{% if not forloop.first %},{% endif %}{{ eq.id }}{% endfor %}">
                                                <input id="collapse-chore-{{ chore.id }}" type="checkbox" class="sr-only" />
                                                <label for="collapse-chore-{{ chore.id }}"
                                                       class="collapse-title p-0 cursor-pointer bg-base-300 border border-base-300 border-b-0 rounded-t-lg">
                                                    <div class="flex items-center justify-between gap-4 p-4">
                                                        <div class="flex items-start gap-3 flex-1 min-w-0">
                                                            <div class="flex-1 min-w-0">
                                                                <h3 class="text-base font-semibold truncate mb-1">{{ chore.name }}</h3>
                                                                <p class="text-sm text-muted truncate">{{ chore.description|default:'—'|truncatechars:120 }}</p>
                                                            </div>
                                                        </div>
                                                        <div class="flex items-center gap-2 flex-shrink-0 whitespace-nowrap">
                                                            <span class="text-sm text-muted mr-2">{{ chore.points }} pts</span>
                                                            {% if chore.location %}<span class="text-sm text-muted mr-2">{{ chore.location.name }}</span>{% endif %}
                                                            <a href="#"
                                                               class="btn btn-sm btn-ghost"
                                                               data-action="open-edit-chore"
                                                               data-chore-id="{{ chore.id }}"
                                                               onclick="event.stopPropagation(); openEditChore && openEditChore({{ chore.id }}); return false;">Edit</a>
                                                            <form method="post"
                                                                  action="{% url 'core:delete_chore' chore.id %}"
                                                                  class="inline"
                                                                  onsubmit="event.stopPropagation(); return confirm('Delete this chore?');">
                                                                {% csrf_token %}
                                                                <button type="submit" class="btn btn-sm btn-error">Delete</button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </label>
                                                <div class="collapse-content p-0 border-t border-base-200 bg-base-100">
                                                    <div class="card-body">
                                                        <div class="grid md:grid-cols-3 gap-4">
                                                            <div class="md:col-span-2 space-y-3">
                                                                {% if chore.description %}
                                                                    <h3 class="font-medium">Description</h3>
                                                                    <p class="text-sm text-muted">{{ chore.description }}</p>
                                                                {% endif %}
                                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                                    <div>
                                                                        <h3 class="font-medium">Recurrence</h3>
                                                                        <p class="text-sm text-muted">
                                                                            {% if chore.is_recurring %}
                                                                                {{ chore.get_recurrence_display }}
                                                                                {% if chore.recurrence == 'W' and chore.recurrence_day_of_week %}— {{ chore.recurrence_day_of_week }}{% endif %}
                                                                                {% if chore.recurrence == 'M' and chore.recurrence_day_of_month %}— day {{ chore.recurrence_day_of_month }}{% endif %}
                                                                            {% else %}
                                                                                One-time
                                                                            {% endif %}
                                                                        </p>
                                                                    </div>
                                                                    <div>
                                                                        <h3 class="font-medium">Point Value</h3>
                                                                        <p class="text-sm text-muted">{{ chore.points }} points</p>
                                                                        <h3 class="font-medium mt-3">Deadline</h3>
                                                                        <p class="text-sm text-muted">
                                                                            {% if chore.time_due %}
                                                                                Due by {{ chore.time_due }}
                                                                            {% else %}
                                                                                &mdash;
                                                                            {% endif %}
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                                <div class="mt-3">
                                                                    <h3 class="font-medium">
                                                                        Penalty
                                                                        {% if chore.penalize_incomplete %}
                                                                            (enabled)
                                                                        {% else %}
                                                                            (disabled)
                                                                        {% endif %}
                                                                    </h3>
                                                                    <p class="text-sm text-muted">
                                                                        {% if chore.penalize_incomplete %}
                                                                            {{ chore.penalty_amount }} points
                                                                        {% else %}
                                                                            No penalty
                                                                        {% endif %}
                                                                    </p>
                                                                </div>
                                                                {% if chore.instructions_video or chore.instructions_video_source %}
                                                                    <div>
                                                                        <h3 class="font-medium">Instructional Video</h3>
                                                                        <p class="text-sm text-muted">
                                                                            {% if chore.instructions_video_source %}
                                                                                <a href="{{ chore.instructions_video_source }}"
                                                                                   target="_blank"
                                                                                   rel="noopener"
                                                                                   class="link link-primary">External video</a>
                                                                            {% elif chore.instructions_video %}
                                                                                <a href="{{ chore.instructions_video.url }}"
                                                                                   target="_blank"
                                                                                   rel="noopener"
                                                                                   class="link link-primary">Download / view video</a>
                                                                            {% endif %}
                                                                        </p>
                                                                    </div>
                                                                {% endif %}
                                                                {# Assignments removed per request #}
                                                            </div>
                                                            <div class="md:col-span-1 self-start">
                                                                {% if chore.equipment.all %}
                                                                    <h3 class="font-medium">Equipment</h3>
                                                                    <p class="text-sm text-muted mb-3">
                                                                        {% for e in chore.equipment.all %}<span class="badge badge-outline mr-1">{{ e.name }}</span>{% endfor %}
                                                                    </p>
                                                                {% endif %}
                                                                {% if chore.tasks.all %}
                                                                    <h3 class="font-medium">Tasks</h3>
                                                                    <ul class="list-disc list-inside text-sm text-muted mb-3">
                                                                        {% for t in chore.tasks.all %}<li>{{ t.name }}</li>{% endfor %}
                                                                    </ul>
                                                                {% endif %}
                                                                <h3 class="font-medium">Notes</h3>
                                                                {% if chore.notes %}
                                                                    <ul class="list-disc list-inside text-sm text-muted">
                                                                        {% for n in chore.notes %}<li class="mb-1">{{ n }}</li>{% endfor %}
                                                                    </ul>
                                                                {% else %}
                                                                    <div class="text-muted">No notes</div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="text-center py-8 text-muted">No chores found</div>
                                {% endif %}
                            </div>
                            <!-- Related lists moved below as separate daisyUI collapses -->
                        </div>
                    </div>
                    <div class="collapse bg-base-200 shadow-sm rounded-lg">
                        <input id="collapse-tasks-toggle"
                               type="radio"
                               name="related-accordion"
                               class="sr-only"
                               checked />
                        <label for="collapse-tasks-toggle" class="collapse-title p-4 cursor-pointer">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-medium">Tasks</h2>
                                <span class="text-sm text-muted">{{ tasks|length }} tasks</span>
                            </div>
                        </label>
                        <div class="collapse-content p-0">
                            <div class="p-4">
                                <div id="tasks-list">
                                    {% if tasks %}
                                        {% for t in tasks %}
                                            <div class="collapse card bg-base-100 shadow-sm rounded-lg mb-3"
                                                 id="task-card-{{ t.id }}"
                                                 data-equipment-ids="{% for eq in t.equipment.all %}{% if not forloop.first %},{% endif %}{{ eq.id }}{% endfor %}">
                                                <input id="collapse-task-{{ t.id }}" type="checkbox" class="sr-only" />
                                                <label for="collapse-task-{{ t.id }}"
                                                       class="collapse-title flex items-start justify-between gap-4 cursor-pointer p-4 bg-base-300 border border-base-300 border-b-0 rounded-t-lg">
                                                    <div class="flex-1">
                                                        <div class="font-semibold">{{ t.name }}</div>
                                                        <div class="text-sm text-muted">{{ t.description|truncatechars:140 }}</div>
                                                    </div>
                                                    <div class="flex items-center gap-2 justify-end whitespace-nowrap">
                                                        <a href="#"
                                                           data-action="open-edit-task"
                                                           data-task-id="{{ t.id }}"
                                                           class="btn btn-sm btn-ghost"
                                                           onclick="event.stopPropagation(); openEditTask && openEditTask({{ t.id }}); return false;">Edit</a>
                                                        <form method="post"
                                                              action="{% url 'core:delete_task' t.id %}"
                                                              class="inline"
                                                              onsubmit="event.stopPropagation(); return confirm('Delete this task?');">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-sm btn-error">Delete</button>
                                                        </form>
                                                    </div>
                                                </label>
                                                <div class="collapse-content p-0 border-t border-base-200 bg-base-100">
                                                    <div class="grid md:grid-cols-3 gap-4">
                                                        <div class="md:col-span-2">
                                                            {% if t.description %}
                                                                <h3 class="font-medium">Description</h3>
                                                                <p class="text-sm text-muted">{{ t.description }}</p>
                                                            {% endif %}
                                                            {% if t.steps %}
                                                                <h3 class="font-medium mt-4">Steps</h3>
                                                                <ul class="list-decimal list-inside text-sm text-muted">
                                                                    {% for s in t.steps %}
                                                                        <li>
                                                                            {{ s.name }}
                                                                            {% if s.description %}: {{ s.description }}{% endif %}
                                                                        </li>
                                                                    {% endfor %}
                                                                </ul>
                                                            {% endif %}
                                                            {# equipment moved to the right column (above notes) to improve layout #}
                                                        </div>
                                                        <div class="md:col-span-1">
                                                            {% if t.equipment.all %}
                                                                <h3 class="font-medium">Equipment</h3>
                                                                <p class="text-sm text-muted mb-3">
                                                                    {% for e in t.equipment.all %}<span class="badge badge-outline mr-1">{{ e.name }}</span>{% endfor %}
                                                                </p>
                                                            {% endif %}
                                                            <h3 class="font-medium">Notes</h3>
                                                            <div class="text-sm text-muted">
                                                                {% for n in t.notes %}
                                                                    <div class="mb-2">{{ n }}</div>
                                                                {% empty %}
                                                                    <div class="text-muted">No notes</div>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-center py-8 text-muted">No tasks found</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="collapse bg-base-200 shadow-sm rounded-lg">
                        <input id="collapse-equipment-toggle"
                               type="radio"
                               name="related-accordion"
                               class="sr-only" />
                        <label for="collapse-equipment-toggle"
                               class="collapse-title p-4 cursor-pointer">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-medium">Equipment</h2>
                                <span class="text-sm text-muted">{{ equipment|length }} items</span>
                            </div>
                        </label>
                        <div class="collapse-content p-0">
                            <div class="p-4 space-y-2">
                                {% if equipment %}
                                    {% for eq in equipment %}
                                        <div class="collapse card bg-base-100 shadow-sm rounded-lg mb-3">
                                            <input id="collapse-equipment-{{ eq.id }}" type="checkbox" class="sr-only" />
                                            <label for="collapse-equipment-{{ eq.id }}"
                                                   class="collapse-title p-0 cursor-pointer bg-base-300 border border-base-300 border-b-0 rounded-t-lg">
                                                <div class="flex items-center justify-between gap-4 p-4">
                                                    <div class="flex items-center gap-3">
                                                        {% if eq.image %}
                                                            <img src="{{ eq.image.url }}"
                                                                 alt="{{ eq.name }}"
                                                                 class="w-12 h-12 object-cover rounded flex-shrink-0" />
                                                        {% endif %}
                                                        <div class="flex-1 min-w-0">
                                                            <h3 class="text-base font-semibold truncate mb-1">{{ eq.name }}</h3>
                                                            <p class="text-sm text-muted truncate">
                                                                {% if eq.description %}
                                                                    {{ eq.description|truncatechars:80 }}
                                                                {% else %}
                                                                    &mdash;
                                                                {% endif %}
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center gap-2 flex-shrink-0 whitespace-nowrap">
                                                        <a href="#"
                                                           class="btn btn-sm btn-ghost"
                                                           data-action="open-edit-equipment"
                                                           data-equipment-id="{{ eq.id }}"
                                                           onclick="openEditEquipment({{ eq.id }}); return false;">Edit</a>
                                                        <form method="post"
                                                              action="{% url 'core:delete_equipment' eq.id %}"
                                                              class="inline"
                                                              onsubmit="return confirm('Delete this equipment item?');">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-sm btn-error">Delete</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </label>
                                            <div class="collapse-content p-0">
                                                <div class="card-body">
                                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                        <div class="md:col-span-2 space-y-4">
                                                            <div>
                                                                <h3 class="font-semibold">Location</h3>
                                                                <p class="text-sm">
                                                                    {% if eq.location %}
                                                                        {{ eq.location.name }}
                                                                    {% else %}
                                                                        &mdash;
                                                                    {% endif %}
                                                                </p>
                                                            </div>
                                                            <div>
                                                                <h3 class="font-semibold">Description</h3>
                                                                <p class="text-sm">
                                                                    {% if eq.description %}
                                                                        {{ eq.description }}
                                                                    {% else %}
                                                                        &mdash;
                                                                    {% endif %}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <div class="self-start md:col-span-1">
                                                            <h3 class="font-semibold">Notes</h3>
                                                            {% if eq.notes %}
                                                                <ul class="list-disc list-inside text-sm space-y-1">
                                                                    {% for note in eq.notes %}<li>{{ note }}</li>{% endfor %}
                                                                </ul>
                                                            {% else %}
                                                                <p class="text-sm">&mdash;</p>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center py-8 text-muted">No equipment found</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="collapse bg-base-200 shadow-sm rounded-lg">
                        <input id="collapse-locations-toggle"
                               type="radio"
                               name="related-accordion"
                               class="sr-only" />
                        <label for="collapse-locations-toggle"
                               class="collapse-title p-4 cursor-pointer">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-medium">Locations</h2>
                                <span class="text-sm text-muted">{{ locations|length }} locations</span>
                            </div>
                        </label>
                        <div class="collapse-content p-0 border-t border-base-200 bg-base-100">
                            <div class="p-4 space-y-2">
                                {% if locations %}
                                    {% for loc in locations %}
                                        <div class="collapse card bg-base-100 shadow-sm rounded-lg mb-3">
                                            <input id="collapse-location-{{ loc.id }}" type="checkbox" class="sr-only" />
                                            <label for="collapse-location-{{ loc.id }}"
                                                   class="collapse-title p-0 cursor-pointer bg-base-300 border border-base-300 border-b-0 rounded-t-lg">
                                                <div class="flex items-center justify-between gap-4 p-4">
                                                    <div class="flex-1 min-w-0">
                                                        <h3 class="text-base font-semibold truncate mb-1">{{ loc.name }}</h3>
                                                        <p class="text-sm text-muted truncate">
                                                            {% if loc.description %}
                                                                {{ loc.description|truncatechars:80 }}
                                                            {% else %}
                                                                &mdash;
                                                            {% endif %}
                                                        </p>
                                                    </div>
                                                    <div class="flex items-center gap-2 flex-shrink-0 whitespace-nowrap">
                                                        <a href="#"
                                                           class="btn btn-sm btn-ghost"
                                                           onclick="openEditLocation({{ loc.id }}); return false;">Edit</a>
                                                        <form method="post"
                                                              action="{% url 'core:delete_location' loc.id %}"
                                                              class="inline"
                                                              onsubmit="return confirm('Delete this location?');">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-sm btn-error">Delete</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </label>
                                            <div class="collapse-content p-0 border-t border-base-200 bg-base-100">
                                                <div class="card-body">
                                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                        <div class="md:col-span-2">
                                                            <h3 class="font-semibold">Description</h3>
                                                            <p class="text-sm">
                                                                {% if loc.description %}
                                                                    {{ loc.description }}
                                                                {% else %}
                                                                    &mdash;
                                                                {% endif %}
                                                            </p>
                                                        </div>
                                                        <div>
                                                            <h3 class="font-semibold">Notes</h3>
                                                            {% if loc.notes %}
                                                                <ul class="list-disc list-inside text-sm">
                                                                    {% for note in loc.notes %}<li>{{ note }}</li>{% endfor %}
                                                                </ul>
                                                            {% else %}
                                                                <p class="text-sm">&mdash;</p>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center py-8 text-muted">No locations found</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    <script src="{% static 'js/chores-open-edit.js' %}"></script>
    <script src="{% static 'js/chores-recurrence.js' %}"></script>
    <script src="{% static 'js/chores-tabs.js' %}"></script>
    <script src="{% static 'js/notes-ui.js' %}"></script>
    <script src="{% static 'js/steps-ui.js' %}"></script>
    <script src="{% static 'js/multi-select-filter.js' %}"></script>
{% endblock %}
